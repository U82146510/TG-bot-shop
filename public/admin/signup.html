<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Signup</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    form, .output { margin-bottom: 20px; padding: 10px; border: 1px solid #000; }
    label { display: block; margin-top: 5px; }
    input, button { margin-top: 5px; padding: 5px; width: 100%; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    nav {
        margin-bottom: 20px;
    }
    nav a {
        margin-right: 10px;
        text-decoration: none;
        color: black;
        font-weight: bold;
    }
    nav a:hover {
        text-decoration: underline;
    }
    #logout-btn {
        padding: 4px 10px;
        width: auto;
        font-size: 0.9em;
        cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Admin Control Panel</h1>

  <nav>
    <a href="/admin/users.html">Users</a>
    <a href="/admin/orders.html">Orders</a>
    <a href="/admin/products.html">Products</a>
    <a href="/admin/items.html">Items</a>
    <a href="/admin/reviews.html">Reviews</a>
    <a href="/admin/payments.html">Payments</a>
    <a href="/admin/signup.html">Create User</a>
    <button id="logout-btn">Logout</button>
  </nav>

  <h2>Register New Admin</h2>
  <form id="signup-form">
    <label>Email:</label>
    <input type="email" name="email" required>

    <label>Password:</label>
    <input type="password" name="password" required>

    <label>Pin (8 digits):</label>
    <input type="password" name="pinCode" required>

    <button type="submit">Create User</button>
  </form>

  <h2>Update Admin Password</h2>
  <form id="update-form">
    <label>Email:</label>
    <input type="email" name="email" required>

    <label>New Password:</label>
    <input type="password" name="password" required>

    <label>Pin (8 digits):</label>
    <input type="password" name="pinCode" required>

    <button type="submit">Update Password</button>
  </form>

  <div class="output">
    <pre id="signup-output">Awaiting signup...</pre>
    <pre id="update-output">Awaiting update...</pre>
  </div>

  <script>
    const signupForm = document.getElementById('signup-form');
    const updateForm = document.getElementById('update-form');
    const signupOutput = document.getElementById('signup-output');
    const updateOutput = document.getElementById('update-output');

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(signupForm);
      const email = formData.get('email');
      const password = formData.get('password');
      const pinCode = formData.get('pinCode');

      if (!email || !password || !pinCode) {
        signupOutput.textContent = 'Please fill all fields.';
        return;
      }

      try {
        const res = await fetch('/admin/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, pinCode })
        });

        const contentType = res.headers.get('content-type');
        if (!res.ok) {
          const text = await res.text();
          signupOutput.textContent = `Error ${res.status}: ${text}`;
          return;
        }

        if (contentType && contentType.includes('application/json')) {
          const data = await res.json();
          signupOutput.textContent = data.message || 'User created successfully. Redirecting...';
          signupForm.reset();
          setTimeout(() => window.location.href = '/admin/users.html', 1000);
        } else {
          signupOutput.textContent = await res.text();
        }
      } catch (err) {
        signupOutput.textContent = `Error: ${err.message}`;
      }
    });

    updateForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(updateForm);
      const email = formData.get('email');
      const password = formData.get('password');
      const pinCode = formData.get('pinCode');

      if (!email || !password || !pinCode) {
        updateOutput.textContent = 'Please fill all fields.';
        return;
      }

      try {
        const res = await fetch('/admin/update', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, pinCode })
        });

        const contentType = res.headers.get('content-type');
        if (!res.ok) {
          const text = await res.text();
          updateOutput.textContent = `Error ${res.status}: ${text}`;
          return;
        }

        if (contentType && contentType.includes('application/json')) {
          const data = await res.json();
          updateOutput.textContent = data.message || 'Password updated successfully.';
          updateForm.reset();
          setTimeout(() => updateOutput.textContent = 'Awaiting update...', 3000);
        } else {
          updateOutput.textContent = await res.text();
        }
      } catch (err) {
        updateOutput.textContent = `Error: ${err.message}`;
      }
    });

    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/admin/logout', {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        if (res.ok) {
          alert('Logged out successfully');
          window.location.href = '/index.html';
        } else {
          const data = await res.json();
          alert(`Logout failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });
  </script>

</body>
</html>
